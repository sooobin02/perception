<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VUI Interaction Experiment</title>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css">
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.0.0"></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    #jspsych-target {
      max-width: 800px;
      margin: 0 auto;
    }
    .recording-container {
      text-align: center;
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
    }
    .vui-image {
      width: 200px;
      height: 200px;
      margin: 20px auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
    }
    .guideline-box {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 20px;
      margin: 20px auto;
      max-width: 500px;
      text-align: left;
      border-radius: 5px;
    }
    .guideline-box h4 {
      margin-top: 0;
      color: #667eea;
    }
    .recording-status {
      font-size: 20px;
      margin: 20px 0;
      min-height: 30px;
    }
    .recording-active {
      color: #dc3545;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    .timer {
      font-size: 24px;
      font-weight: bold;
      margin: 15px 0;
    }
    .control-buttons {
      margin-top: 30px;
    }
    .control-buttons button {
      font-size: 18px;
      padding: 15px 40px;
      margin: 0 10px;
      cursor: pointer;
    }
    .record-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 5px;
    }
    .record-btn:hover:not(:disabled) {
      background-color: #c82333;
    }
    .stop-btn {
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
    }
    .stop-btn:hover:not(:disabled) {
      background-color: #218838;
    }
    .next-btn {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }
    .next-btn:hover:not(:disabled) {
      background-color: #0069d9;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .rating-prompt {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
    }
    .rating-prompt h4 {
      margin-top: 0;
      color: #333;
    }
    .multiple-choice-section {
      margin: 30px 0;
      padding: 20px;
      background: #f0f8ff;
      border-radius: 5px;
      border: 2px solid #667eea;
    }
    .multiple-choice-section h4 {
      margin-top: 0;
      color: #667eea;
    }
    .choice-option {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      display: block;
    }
    .choice-option:hover {
      background: #e6f2ff;
    }
    .choice-option input[type="radio"] {
      margin-right: 10px;
    }
    .recording-section {
      margin-top: 30px;
      padding: 20px;
      background: #fff3cd;
      border-radius: 5px;
      border: 2px solid #ffc107;
      display: none;
    }
    .recording-section.visible {
      display: block;
    }
    .recording-section h4 {
      margin-top: 0;
      color: #856404;
    }
    .record-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
    }
    .record-btn-main {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 15px 30px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    .stop-btn-main {
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 15px 30px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    .record-btn-main:disabled, .stop-btn-main:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .consent-box {
      max-width: 700px;
      margin: 20px auto;
      padding: 30px;
      background: #f8f9fa;
      border: 2px solid #667eea;
      border-radius: 10px;
      text-align: left;
    }
    .consent-box h2 {
      color: #667eea;
      margin-top: 0;
      text-align: center;
    }
    .consent-box p {
      line-height: 1.8;
      margin: 15px 0;
    }
    .consent-checkbox {
      margin: 30px 0 20px 0;
      padding: 20px;
      background: white;
      border-radius: 5px;
      border: 2px solid #667eea;
    }
    .consent-checkbox label {
      display: flex;
      align-items: flex-start;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    .consent-checkbox input[type="checkbox"] {
      margin-right: 15px;
      margin-top: 3px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>
  
  <script>
    console.log('Script starting...');

    /* ===== CONFIG ===== */
    const GAS_ENDPOINT_RATING = 'https://script.google.com/macros/s/AKfycbynkEwPJ19e8QGs1w4_TakbVLb3SG5aVXNN2_w0yFi8A-KZQAc0olhIpr3jquyNn7cIrA/exec';
    const GAS_ENDPOINT_RECORDING = 'https://script.google.com/macros/s/AKfycbzH6zFAwQjJ9ekXi_3m_XL852zxY0CDxktTshak8P47mf9VazFIBjPAvM0RfRhwaUUb/exec';

    /* ===== STIMULI ===== */
    const STIMULI = [
      { file: 'audio/c11.wav' },
      { file: 'audio/c12.wav' },
      { file: 'audio/c21.wav' },
      { file: 'audio/c22.wav' }
    ];

    const INTRO_AUDIO = 'audio/intro.wav';

    /* ===== GLOBAL STATE ===== */
    let mediaRecorder = null;
    let audioChunks = [];
    let participantId = null;
    let demographicsData = null;
    let currentTimerInterval = null;
    let isRecording = false;
    let currentTrialStartTime = null;
    let responseRecordingChunks = [];
    let responseMediaRecorder = null;
    let trialDataStore = {};

    /* ===== INIT ===== */
    let jsPsych;
    try {
      jsPsych = initJsPsych({
        display_element: 'jspsych-target',
        on_finish: async () => {
          console.log('Experiment finished');
          const ok = await uploadAllRowsToGoogle();
          if (!ok) {
            const csv = jsPsych.data.get().csv();
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; 
            a.download = 'data_fallback.csv';
            a.textContent = 'Download CSV (upload failed)';
            a.style.display = 'block';
            a.style.margin = '20px auto';
            a.style.textAlign = 'center';
            document.body.appendChild(a);
          }
        }
      });
      console.log('jsPsych initialized:', jsPsych);
    } catch (error) {
      console.error('Error initializing jsPsych:', error);
    }

    /* ===== PRELOAD ===== */
    const audioFiles = STIMULI.map(s => s.file);
    if (INTRO_AUDIO) audioFiles.unshift(INTRO_AUDIO);

    const preload = {
      type: jsPsychPreload,
      audio: audioFiles,
      on_error: (file) => {
        console.warn('Failed to load:', file);
      },
      on_success: () => {
        console.log('All files preloaded successfully');
      }
    };

    /* ===== WELCOME ===== */
    const welcome = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>VUI Interaction Experiment</h2>
                 <p>ìŒì„± ì¸í„°í˜ì´ìŠ¤ì™€ ìƒí˜¸ì‘ìš©í•˜ê³  í‰ê°€í•˜ëŠ” ì‹¤í—˜ì…ë‹ˆë‹¤.</p>
                 <p><strong>ì¡°ìš©í•œ í™˜ê²½ì—ì„œ ì§„í–‰í•´ì£¼ì„¸ìš”.</strong></p>`,
      choices: ['ì‹œì‘']
    };

    /* ===== CONSENT FORM ===== */
    const consent = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="consent-box">
          <h2>ë™ì˜ì„œ</h2>
          <p>ì‹¤í—˜ì„ ì‹œì‘í•˜ê¸° ì „ì—, ê°„ë‹¨í•œ ë™ì˜ì„œ ì‘ì„±ì„ í•˜ê² ìŠµë‹ˆë‹¤.</p>
          
          <p><strong>ì—°êµ¬ì±…ì„ì:</strong> ì˜¤ìˆ˜ë¹ˆ<br>
          <strong>ì—°ë½ì²˜:</strong> sooobin02@g.skku.edu</p>
          
          <p><strong>ì—°êµ¬ ëª©ì :</strong><br>
          ì´ë¦„, ì„±ë³„, ë‚˜ì´ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìœ¼ë‚˜, ì´ ì •ë³´ì™€ ê³¼ì œì— ëŒ€í•œ ì‘ë‹µì€ ê¸°ë°€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.</p>
          
          <p><strong>ì ˆì°¨:</strong><br>
          ì´ ì—°êµ¬ì— ì°¸ì—¬í•˜ëŠ” ë° ì•½ 10ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.<br>
          ìŒì„± ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ì™€ì˜ ìƒí˜¸ì‘ìš©ì„ ì‚´í´ë³´ê¸° ìœ„í•´ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
          ìŒì„± AIì˜ ë°œí™”ë¥¼ ì˜ ë“¤ì–´ë³´ì‹œê³ , ì‹¤ì œ ìŒì„± AIì™€ ëŒ€í™”í•˜ë“¯ì´ ì„í•´ì£¼ì‹œê¸¸ ë°”ëë‹ˆë‹¤.</p>
          
          <p><strong>ìœ„í—˜:</strong> ì´ ì—°êµ¬ì™€ ê´€ë ¨ëœ ì•Œë ¤ì§„ ìœ„í—˜ì€ ì—†ìŠµë‹ˆë‹¤.</p>
          
          <p><strong>ê¸°ë°€ì„±:</strong> ì´ë¦„, ì—°ë½ì²˜ ë° ê¸°íƒ€ ì‹ë³„ ê°€ëŠ¥í•œ ì •ë³´ëŠ” ë¹„ê³µê°œë¡œ ìœ ì§€ë˜ë©°, ìˆ˜ì§‘ëœ ë°ì´í„°ì™€ ì—°ê²°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì°¸ê°€ìëŠ” í•™ìˆ  ì¶œíŒë¬¼/ë°œí‘œì—ì„œ ì´ë¦„ìœ¼ë¡œ ì‹ë³„ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì£¼ì—°êµ¬ìì™€ ì—°êµ¬ì‹¤ êµ¬ì„±ì›ë§Œ ì´ ì •ë³´ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          
          <div class="consent-checkbox">
            <label>
              <input type="checkbox" id="consentCheck">
              <span>ë™ì˜ì„œë¥¼ ì½ê³ , ì´ ì—°êµ¬ì— ì°¸ì—¬í•˜ê¸°ë¡œ ë™ì˜í•©ë‹ˆë‹¤.</span>
            </label>
          </div>
        </div>
      `,
      choices: ['ë‹¤ìŒ'],
      on_load: () => {
        const btn = document.querySelector('.jspsych-btn');
        btn.disabled = true;
        btn.style.opacity = '0.5';
        
        const checkbox = document.getElementById('consentCheck');
        checkbox.addEventListener('change', () => {
          btn.disabled = !checkbox.checked;
          btn.style.opacity = checkbox.checked ? '1' : '0.5';
        });
      }
    };

    /* ===== DEMOGRAPHIC SURVEY ===== */
    const demographics = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<h3>ì°¸ê°€ì ì •ë³´</h3><p>ì‹¤í—˜ì„ ì‹œì‘í•˜ê¸° ì „ì— ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>',
      html: `
        <div style="text-align: left; max-width: 500px; margin: 0 auto;">
          <p><label for="gender"><strong>ì„±ë³„:</strong></label><br>
          <input type="radio" name="gender" value="ë‚¨" required> ë‚¨
          <input type="radio" name="gender" value="ì—¬" required> ì—¬</p>
          
          <p><label for="birth_year"><strong>íƒœì–´ë‚œ í•´:</strong></label><br>
          <input type="text" id="birth_year" name="birth_year" placeholder="YYYY (ì˜ˆ: 1995)" pattern="[0-9]{4}" required style="width: 150px;"></p>
          
          <p><label for="birth_month"><strong>íƒœì–´ë‚œ ì›”:</strong></label><br>
          <input type="text" id="birth_month" name="birth_month" placeholder="MM (ì˜ˆ: 03)" pattern="[0-9]{1,2}" required style="width: 80px;"></p>
          
          <p><label for="native_lang"><strong>ëª¨êµ­ì–´:</strong></label><br>
          <input type="text" id="native_lang" name="native_lang" placeholder="ì˜ˆ: í•œêµ­ì–´" required style="width: 200px;"></p>
          
          <p><label for="dialect"><strong>ë°©ì–¸:</strong></label><br>
          <input type="text" id="dialect" name="dialect" placeholder="ì˜ˆ: ì„œìš¸, ê²½ìƒë„" style="width: 200px;"></p>
        </div>
      `,
      button_label: 'ì œì¶œ',
      data: { task: 'demographics' },
      on_finish: (data) => {
        demographicsData = data.response;
        participantId = 'P' + Date.now();
        data.participant_id = participantId;
        data.user_agent = navigator.userAgent;
        data.timestamp = new Date().toISOString();
        console.log('Demographics saved:', demographicsData);
      }
    };

    /* ===== MICROPHONE PERMISSION ===== */
    const mic_permission = {
      type: jsPsychHtmlButtonResponse,
      stimulus: '<h3>ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­</h3><p>ë…¹ìŒì„ ìœ„í•´ ë§ˆì´í¬ ì‚¬ìš©ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</p>',
      choices: ['ë§ˆì´í¬ í—ˆìš©'],
      on_finish: async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          stream.getTracks().forEach(track => track.stop());
          console.log('Microphone permission granted');
        } catch (err) {
          alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ë¥¼ í—ˆìš©í•´ì£¼ì„¸ìš”.');
          console.error('Microphone error:', err);
        }
      }
    };

    /* ===== INTRO PAGE WITH RECORDING ===== */
    const intro_page = {
      type: jsPsychHtmlButtonResponse,
      stimulus: () => {
        return `
          <div class="recording-container">
            <div class="vui-image">ğŸ¤</div>
            
            <div class="guideline-box">
              <h4>ì§ˆë¬¸ ì˜ˆì‹œ:</h4>
              <p>"ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë•Œ?"<br>
              "ì˜¤ëŠ˜ ì¼ì •ì€ ë­ì•¼?"<br>
              "Olivia Deanì˜ 'Man I Need' í‹€ì–´ì¤˜."</p>
            </div>
            
            <div class="recording-status" id="status">VUIê°€ ì‘ë‹µì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</div>
            <div class="timer" id="timer"></div>
            
            <div class="control-buttons">
              <button class="record-btn" id="recordBtn" onclick="handleRecord()" disabled>ë…¹ìŒ ì‹œì‘</button>
              <button class="stop-btn" id="stopBtn" onclick="handleStop()" disabled>ë…¹ìŒ ì™„ë£Œ</button>
              <button class="next-btn" id="nextBtn" style="display:none;">ë‹¤ìŒ</button>
            </div>
          </div>
        `;
      },
      choices: [],
      on_load: async function() {
        console.log('Intro page loaded');
        audioChunks = [];
        isRecording = false;
        
        const audio = new Audio(INTRO_AUDIO);
        const statusEl = document.getElementById('status');
        const recordBtn = document.getElementById('recordBtn');
        
        statusEl.innerHTML = 'ğŸ”Š VUIê°€ ë§í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        
        audio.onended = () => {
          statusEl.innerHTML = 'ì¤€ë¹„ë˜ë©´ ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”';
          recordBtn.disabled = false;
        };
        
        audio.onerror = (e) => {
          console.error('Audio playback error:', e);
          statusEl.innerHTML = 'ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨. ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê³„ì† ì§„í–‰í•˜ì„¸ìš”.';
          recordBtn.disabled = false;
        };
        
        try {
          await audio.play();
        } catch (err) {
          console.error('Play error:', err);
          statusEl.innerHTML = 'ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨. ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê³„ì† ì§„í–‰í•˜ì„¸ìš”.';
          recordBtn.disabled = false;
        }
        
        window.handleRecord = async () => {
          const recordBtn = document.getElementById('recordBtn');
          const stopBtn = document.getElementById('stopBtn');
          const statusEl = document.getElementById('status');
          
          if (isRecording) return;
          
          try {
            await startRecording();
            isRecording = true;
            
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            
            if (statusEl) {
              statusEl.innerHTML = 'ğŸ”´ ë…¹ìŒ ì¤‘...';
              statusEl.classList.add('recording-active');
            }
            
            let seconds = 0;
            currentTimerInterval = setInterval(() => {
              seconds++;
              const timerEl = document.getElementById('timer');
              if (timerEl) {
                timerEl.textContent = `${seconds}ì´ˆ`;
              }
            }, 1000);
            
            console.log('Recording started');
          } catch (err) {
            console.error('Failed to start recording:', err);
            alert('ë…¹ìŒ ì‹œì‘ ì‹¤íŒ¨: ' + err.message);
          }
        };
        
        window.handleStop = async () => {
          const stopBtn = document.getElementById('stopBtn');
          const nextBtn = document.getElementById('nextBtn');
          const statusEl = document.getElementById('status');
          
          if (!isRecording) return;
          
          stopBtn.disabled = true;
          
          try {
            if (statusEl) {
              statusEl.innerHTML = 'ë…¹ìŒ ì¤‘ì§€ ì¤‘...';
              statusEl.classList.remove('recording-active');
            }
            
            await stopRecording();
            isRecording = false;
            
            if (currentTimerInterval) {
              clearInterval(currentTimerInterval);
              currentTimerInterval = null;
            }
            
            console.log('Recording stopped, chunks:', audioChunks.length);
            
            if (audioChunks.length > 0) {
              if (statusEl) {
                statusEl.innerHTML = 'WAV ë³€í™˜ ì¤‘...';
              }
              
              const webmBlob = new Blob(audioChunks, { type: 'audio/webm' });
              console.log('WebM size:', webmBlob.size, 'bytes');
              
              const wavBlob = await convertWebMToWav(webmBlob);
              console.log('WAV size:', wavBlob.size, 'bytes');
              
              if (statusEl) {
                statusEl.innerHTML = 'â³ ì„œë²„ì— ì—…ë¡œë“œ ì¤‘...';
              }
              
              const success = await uploadIntroRecording(wavBlob);
              
              if (success) {
                console.log('âœ“ Upload successful');
                if (statusEl) {
                  statusEl.innerHTML = 'âœ… ì—…ë¡œë“œ ì™„ë£Œ!';
                }
              } else {
                console.error('âœ— Upload failed');
                if (statusEl) {
                  statusEl.innerHTML = 'âš ï¸ ì—…ë¡œë“œ ì‹¤íŒ¨. ë‹¤ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê³„ì† ì§„í–‰í•˜ì„¸ìš”.';
                }
              }
            } else {
              if (statusEl) {
                statusEl.innerHTML = 'âš ï¸ ë…¹ìŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
              }
            }
            
            if (nextBtn) {
              nextBtn.style.display = 'inline-block';
              nextBtn.onclick = () => {
                jsPsych.finishTrial({
                  task: 'intro_recording',
                  timestamp: new Date().toISOString()
                });
              };
            }
            
          } catch (err) {
            console.error('Error during stop:', err);
            if (statusEl) {
              statusEl.innerHTML = 'âŒ ì˜¤ë¥˜: ' + err.message;
            }
            if (nextBtn) {
              nextBtn.style.display = 'inline-block';
              nextBtn.onclick = () => {
                jsPsych.finishTrial({
                  task: 'intro_recording',
                  error: err.message,
                  timestamp: new Date().toISOString()
                });
              };
            }
          }
        };
      }
    };

    /* ===== RECORDING FUNCTIONS ===== */
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            channelCount: 1,
            sampleRate: 16000
          } 
        });
        
        audioChunks = [];
        
        const options = { mimeType: 'audio/webm' };
        mediaRecorder = new MediaRecorder(stream, options);
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };
        
        mediaRecorder.onerror = (event) => {
          console.error('MediaRecorder error:', event);
        };
        
        mediaRecorder.start(100);
        console.log('MediaRecorder started');
      } catch (err) {
        console.error('Recording start error:', err);
        throw err;
      }
    }

    function stopRecording() {
      return new Promise((resolve, reject) => {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
          console.log('MediaRecorder already inactive');
          resolve();
          return;
        }
        
        const timeout = setTimeout(() => {
          reject(new Error('Recording stop timeout'));
        }, 5000);
        
        mediaRecorder.onstop = () => {
          clearTimeout(timeout);
          mediaRecorder.stream.getTracks().forEach(track => track.stop());
          console.log('MediaRecorder stopped and tracks released');
          resolve();
        };
        
        try {
          mediaRecorder.stop();
        } catch (err) {
          clearTimeout(timeout);
          reject(err);
        }
      });
    }

    /* ===== RESPONSE RECORDING FUNCTIONS ===== */
    async function startResponseRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            channelCount: 1,
            sampleRate: 16000
          } 
        });
        
        responseRecordingChunks = [];
        
        const options = { mimeType: 'audio/webm' };
        responseMediaRecorder = new MediaRecorder(stream, options);
        
        responseMediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            responseRecordingChunks.push(event.data);
          }
        };
        
        responseMediaRecorder.onerror = (event) => {
          console.error('Response MediaRecorder error:', event);
        };
        
        responseMediaRecorder.start(100);
        console.log('Response recording started');
      } catch (err) {
        console.error('Response recording start error:', err);
        throw err;
      }
    }

    function stopResponseRecording() {
      return new Promise((resolve, reject) => {
        if (!responseMediaRecorder || responseMediaRecorder.state === 'inactive') {
          console.log('Response MediaRecorder already inactive');
          resolve();
          return;
        }
        
        const timeout = setTimeout(() => {
          reject(new Error('Response recording stop timeout'));
        }, 5000);
        
        responseMediaRecorder.onstop = () => {
          clearTimeout(timeout);
          responseMediaRecorder.stream.getTracks().forEach(track => track.stop());
          console.log('Response MediaRecorder stopped');
          resolve();
        };
        
        try {
          responseMediaRecorder.stop();
        } catch (err) {
          clearTimeout(timeout);
          reject(err);
        }
      });
    }

    /* ===== WEBM TO WAV CONVERSION ===== */
    async function convertWebMToWav(webmBlob) {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const arrayBuffer = await webmBlob.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        
        console.log('Audio decoded:', {
          duration: audioBuffer.duration,
          sampleRate: audioBuffer.sampleRate,
          channels: audioBuffer.numberOfChannels
        });
        
        const wavBlob = audioBufferToWav(audioBuffer);
        await audioContext.close();
        
        return wavBlob;
      } catch (err) {
        console.error('WAV conversion error:', err);
        throw new Error('WAV ë³€í™˜ ì‹¤íŒ¨: ' + err.message);
      }
    }

    function audioBufferToWav(audioBuffer) {
      const numChannels = 1;
      const sampleRate = audioBuffer.sampleRate;
      const format = 1;
      const bitDepth = 16;
      
      const bytesPerSample = bitDepth / 8;
      const blockAlign = numChannels * bytesPerSample;
      
      const samples = audioBuffer.getChannelData(0);
      const dataLength = samples.length * blockAlign;
      
      const buffer = new ArrayBuffer(44 + dataLength);
      const view = new DataView(buffer);
      
      writeString(view, 0, 'RIFF');
      view.setUint32(4, 36 + dataLength, true);
      writeString(view, 8, 'WAVE');
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, format, true);
      view.setUint16(22, numChannels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * blockAlign, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, bitDepth, true);
      writeString(view, 36, 'data');
      view.setUint32(40, dataLength, true);
      
      const offset = 44;
      for (let i = 0; i < samples.length; i++) {
        const sample = Math.max(-1, Math.min(1, samples[i]));
        const int16 = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
        view.setInt16(offset + i * 2, int16, true);
      }
      
      return new Blob([buffer], { type: 'audio/wav' });
    }

    function writeString(view, offset, string) {
      for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
      }
    }

    /* ===== UPLOAD INTRO RECORDING ===== */
    async function uploadIntroRecording(wavBlob) {
      if (!GAS_ENDPOINT_RECORDING || GAS_ENDPOINT_RECORDING === 'YOUR_APPS_SCRIPT_URL') {
        console.error('Recording endpoint not configured!');
        return false;
      }

      if (!demographicsData) {
        console.error('Demographics data not available!');
        return false;
      }

      try {
        const base64Audio = await blobToBase64(wavBlob);
        
        const payload = {
          participant_id: participantId,
          sentence_index: 0,
          sentence: 'intro_user_query',
          audio_data: base64Audio,
          timestamp: new Date().toISOString(),
          demographics: demographicsData
        };

        console.log('Uploading intro recording...');

        await fetch(GAS_ENDPOINT_RECORDING, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        });

        console.log('Intro recording upload attempted');
        return true;
        
      } catch (err) {
        console.error('Upload error:', err);
        return false;
      }
    }

    /* ===== UPLOAD RESPONSE RECORDING ===== */
    async function uploadResponseRecording(wavBlob, stimulusFile, trialIndex) {
      if (!GAS_ENDPOINT_RECORDING) {
        console.error('Recording endpoint not configured!');
        return false;
      }

      try {
        const base64Audio = await blobToBase64(wavBlob);
        
        const payload = {
          participant_id: participantId,
          sentence_index: trialIndex,
          sentence: `response_to_${stimulusFile}`,
          audio_data: base64Audio,
          timestamp: new Date().toISOString(),
          demographics: demographicsData
        };

        console.log('Uploading response recording...');

        await fetch(GAS_ENDPOINT_RECORDING, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        });

        console.log('Response recording upload attempted');
        return true;
        
      } catch (err) {
        console.error('Upload error:', err);
        return false;
      }
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    /* ===== RATING TRIAL ===== */
    const rating_trial = {
      type: jsPsychSurveyHtmlForm,
      html: function() {
        const currentStimulus = jsPsych.evaluateTimelineVariable('file');
        console.log('Audio path:', currentStimulus);
        
        return `
          <div style="max-width: 800px; margin: 0 auto; text-align: center;">
            <h3>ìŒì„± ì‘ë‹µ í‰ê°€</h3>
            
            <div class="vui-image">ğŸ™ï¸</div>
            
            <div style="margin: 30px 0;">
              <button id="playBtn" type="button"
                style="font-size: 18px; padding: 15px 40px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                â–¶ï¸ ìŒì„± ì¬ìƒ
              </button>
              <div id="audioStatus" style="margin-top: 15px; min-height: 24px; color: #666;"></div>
            </div>
            <audio id="trialAudio" preload="auto" style="display:none;">
              <source src="${currentStimulus}" type="audio/wav">
            </audio>

            <div class="rating-prompt">
              <h4>1. ì´ ìŒì„±ì´ ì–¼ë§ˆë‚˜ ê·€ì—½ê²Œ ë“¤ë¦¬ë‚˜ìš”?</h4>
              <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0;">
                <span>ì „í˜€ ê·€ì—½ì§€ ì•ŠìŒ</span>
                <input type="range" id="slider1" name="cuteness" min="1" max="7" value="4" 
                  style="width: 300px; cursor: pointer;">
                <span>ë§¤ìš° ê·€ì—¬ì›€</span>
              </div>
              <div id="slider1Value" style="font-size: 18px; font-weight: bold; color: #667eea;">4</div>
            </div>

            <div class="rating-prompt">
              <h4>2. ì´ ìŒì„±ê³¼ ëŒ€í™”ë¥¼ ê³„ì†í•˜ê³  ì‹¶ë‚˜ìš”?</h4>
              <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0;">
                <span>ì „í˜€ ê·¸ë ‡ì§€ ì•ŠìŒ</span>
                <input type="range" id="slider2" name="continue" min="1" max="7" value="4" 
                  style="width: 300px; cursor: pointer;">
                <span>ë§¤ìš° ê·¸ëŸ¬í•¨</span>
              </div>
              <div id="slider2Value" style="font-size: 18px; font-weight: bold; color: #667eea;">4</div>
            </div>

            <div class="multiple-choice-section">
              <h4>3. ì´ ìŒì„±ì— ì–´ë–»ê²Œ ëŒ€ì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h4>
              <div style="text-align: left; max-width: 600px; margin: 20px auto;">
                <label class="choice-option">
                  <input type="radio" name="response_choice" id="choice1" value="choice1" required>
                  ë˜‘ê°™ì€ ë§ì„ ë°˜ë³µí•  ê²ƒì´ë‹¤.
                </label>
                <label class="choice-option">
                  <input type="radio" name="response_choice" id="choice2" value="choice2">
                  ë˜‘ê°™ì´ ë°˜ë³µí•˜ë˜, ì²œì²œíˆ ë§í•  ê²ƒì´ë‹¤.
                </label>
                <label class="choice-option">
                  <input type="radio" name="response_choice" id="choice3" value="choice3">
                  ë™ì¼í•œ ë¶€íƒì„ ë‹¤ë¥´ê²Œ ë§í•  ê²ƒì´ë‹¤.
                </label>
                <label class="choice-option">
                  <input type="radio" name="response_choice" id="choice4" value="choice4">
                  ìƒˆë¡œìš´ ë¶€íƒì„ í•  ê²ƒì´ë‹¤.
                </label>
                <label class="choice-option">
                  <input type="radio" name="response_choice" id="choice5" value="choice5">
                  ëŒ€í™”ë¥¼ ì´ì–´ë‚˜ê°€ì§€ ì•Šì„ ê²ƒì´ë‹¤.
                </label>
                <label class="choice-option">
                  <input type="radio" name="response_choice" id="choice6" value="choice6">
                  ê¸°íƒ€ (ì§ì ‘ ì…ë ¥):
                </label>
                <input type="text" id="otherText" name="other_text" placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”" 
                  style="width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px;" disabled>
              </div>
            </div>

            <div class="recording-section" id="recordingSection">
              <h4>ğŸ¤ ìŒì„± ë…¹ìŒ</h4>
              <div id="selectedResponse" style="font-size: 16px; margin: 15px 0; padding: 15px; background: white; border-radius: 4px; min-height: 40px;">
                ìœ„ì—ì„œ ì‘ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”
              </div>
              <div class="record-controls">
                <button id="recordBtn" type="button" class="record-btn-main" disabled>
                  ğŸ”´ ë…¹ìŒ ì‹œì‘
                </button>
                <button id="stopBtn" type="button" class="stop-btn-main" disabled>
                  â¹ï¸ ë…¹ìŒ ì¢…ë£Œ
                </button>
              </div>
              <div id="recordStatus" style="margin-top: 15px; min-height: 24px;"></div>
              <div id="recordTimer" style="font-size: 20px; font-weight: bold; margin-top: 10px;"></div>
            </div>
          </div>
        `;
      },
      button_label: 'ë‹¤ìŒ',
      on_load: function() {
        currentTrialStartTime = new Date().toISOString();
        const audioPath = jsPsych.evaluateTimelineVariable('file');
        console.log('on_load - Audio path:', audioPath);
        
        trialDataStore = {
          slider1Value: 4,
          slider2Value: 4,
          responseChoice: null,
          otherText: ''
        };
        
        window.trialState = {
          audioPlayed: false,
          slider1Moved: false,
          slider2Moved: false,
          choiceSelected: false,
          recordingCompleted: false
        };
        
        let recordingInProgress = false;
        let timerInterval = null;
        
        const submitBtn = document.querySelector('#jspsych-survey-html-form-next');
        if (submitBtn) submitBtn.style.display = 'none';
        
        const audioElement = document.getElementById('trialAudio');
        const playBtn = document.getElementById('playBtn');
        const audioStatus = document.getElementById('audioStatus');
        const recordingSection = document.getElementById('recordingSection');
        const selectedResponseDiv = document.getElementById('selectedResponse');
        const otherTextInput = document.getElementById('otherText');
        
        const responseTexts = {
          'choice1': 'ë˜‘ê°™ì€ ë§ì„ ë°˜ë³µí•  ê²ƒì´ë‹¤.',
          'choice2': 'ë˜‘ê°™ì´ ë°˜ë³µí•˜ë˜, ì²œì²œíˆ ë§í•  ê²ƒì´ë‹¤.',
          'choice3': 'ë™ì¼í•œ ë¶€íƒì„ ë‹¤ë¥´ê²Œ ë§í•  ê²ƒì´ë‹¤.',
          'choice4': 'ìƒˆë¡œìš´ ë¶€íƒì„ í•  ê²ƒì´ë‹¤.',
          'choice5': 'ëŒ€í™”ë¥¼ ì´ì–´ë‚˜ê°€ì§€ ì•Šì„ ê²ƒì´ë‹¤.'
        };
        
        // Auto-play audio on page load
        audioStatus.textContent = 'ğŸ”Š ìŒì„± ì¬ìƒ ì¤‘...';
        audioStatus.style.color = '#667eea';
        playBtn.disabled = true;
        
        audioElement.play().catch((err) => {
          console.error('Auto-play error:', err);
          audioStatus.textContent = 'â–¶ï¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŒì„±ì„ ë“¤ì–´ì£¼ì„¸ìš”';
          audioStatus.style.color = '#666';
          playBtn.disabled = false;
        });
        
        playBtn.addEventListener('click', () => {
          playBtn.disabled = true;
          audioStatus.textContent = 'ì¬ìƒ ì¤‘...';
          audioStatus.style.color = '#667eea';
          audioElement.play();
        });
        
        audioElement.addEventListener('ended', () => {
          audioStatus.textContent = 'âœ… ì¬ìƒ ì™„ë£Œ';
          audioStatus.style.color = '#28a745';
          playBtn.disabled = false;
          playBtn.textContent = 'ğŸ” ë‹¤ì‹œ ë“£ê¸°';
          window.trialState.audioPlayed = true;
          checkSubmitReady();
        });
        
        audioElement.addEventListener('error', (e) => {
          audioStatus.textContent = 'âŒ ì¬ìƒ ì˜¤ë¥˜';
          audioStatus.style.color = '#dc3545';
          playBtn.disabled = false;
          console.error('Audio error:', e);
        });
        
        setTimeout(() => {
          const slider1 = document.getElementById('slider1');
          const slider2 = document.getElementById('slider2');
          const slider1Value = document.getElementById('slider1Value');
          const slider2Value = document.getElementById('slider2Value');
          
          if (slider1) {
            slider1.addEventListener('input', () => {
              slider1Value.textContent = slider1.value;
              trialDataStore.slider1Value = parseInt(slider1.value);
              window.trialState.slider1Moved = true;
              checkSubmitReady();
            });
          }
          
          if (slider2) {
            slider2.addEventListener('input', () => {
              slider2Value.textContent = slider2.value;
              trialDataStore.slider2Value = parseInt(slider2.value);
              window.trialState.slider2Moved = true;
              checkSubmitReady();
            });
          }
        }, 100);
        
        const radioButtons = document.querySelectorAll('input[name="response_choice"]');
        radioButtons.forEach(radio => {
          radio.addEventListener('change', (e) => {
            window.trialState.choiceSelected = true;
            trialDataStore.responseChoice = e.target.value;
            
            const recordBtn = document.getElementById('recordBtn');
            
            // If choice5 is selected, skip recording section entirely
            if (e.target.id === 'choice5') {
              recordingSection.classList.remove('visible');
              window.trialState.recordingCompleted = true; // Mark as completed to allow moving forward
              otherTextInput.disabled = true;
              otherTextInput.value = '';
              trialDataStore.otherText = '';
              checkSubmitReady();
              return;
            }
            
            // For all other choices, show recording section
            recordingSection.classList.add('visible');
            window.trialState.recordingCompleted = false; // Reset recording state
            
            if (e.target.id === 'choice6') {
              otherTextInput.disabled = false;
              selectedResponseDiv.textContent = 'ì•„ë˜ ì…ë ¥ë€ì— ë§í•  ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ë…¹ìŒí•´ì£¼ì„¸ìš”';
              recordBtn.disabled = otherTextInput.value.trim() === '';
            } else {
              otherTextInput.disabled = true;
              otherTextInput.value = '';
              trialDataStore.otherText = '';
              selectedResponseDiv.textContent = `ë‹µë³€ì„ ì§ì ‘ ë…¹ìŒí•´ì£¼ì„¸ìš”.`;
              recordBtn.disabled = false;
            }
            
            if (submitBtn) submitBtn.style.display = 'none';
            recordingSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            checkSubmitReady();
          });
        });
        
        otherTextInput.addEventListener('input', () => {
          const recordBtn = document.getElementById('recordBtn');
          const choice6 = document.getElementById('choice6');
          trialDataStore.otherText = otherTextInput.value;
          
          if (choice6 && choice6.checked) {
            recordBtn.disabled = otherTextInput.value.trim() === '';
            if (otherTextInput.value.trim() !== '') {
              selectedResponseDiv.textContent = `"${otherTextInput.value}"`;
            }
          }
        });
        
        function checkSubmitReady() {
          const submitBtn = document.querySelector('#jspsych-survey-html-form-next');
          
          console.log('Check submit ready:', window.trialState);
          
          if (window.trialState.audioPlayed && 
              window.trialState.slider1Moved && 
              window.trialState.slider2Moved && 
              window.trialState.choiceSelected && 
              window.trialState.recordingCompleted) {
            if (submitBtn) {
              submitBtn.style.display = 'inline-block';
              console.log('âœ… Submit button enabled');
            }
          } else {
            if (submitBtn) {
              submitBtn.style.display = 'none';
            }
          }
        }
        
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        
        recordBtn.addEventListener('click', async () => {
          if (recordingInProgress) return;
          
          const recordStatus = document.getElementById('recordStatus');
          const recordTimer = document.getElementById('recordTimer');
          
          try {
            await startResponseRecording();
            recordingInProgress = true;
            
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            recordStatus.textContent = 'ğŸ”´ ë…¹ìŒ ì¤‘...';
            recordStatus.style.color = '#dc3545';
            
            let seconds = 0;
            recordTimer.textContent = '0ì´ˆ';
            timerInterval = setInterval(() => {
              seconds++;
              recordTimer.textContent = `${seconds}ì´ˆ`;
            }, 1000);
            
            console.log('Recording started');
          } catch (err) {
            console.error('Recording start error:', err);
            alert('ë…¹ìŒ ì‹œì‘ ì‹¤íŒ¨: ' + err.message);
          }
        });
        
        stopBtn.addEventListener('click', async () => {
          if (!recordingInProgress) return;
          
          const recordStatus = document.getElementById('recordStatus');
          
          stopBtn.disabled = true;
          recordStatus.textContent = 'ì²˜ë¦¬ ì¤‘...';
          recordStatus.style.color = '#666';
          
          try {
            await stopResponseRecording();
            recordingInProgress = false;
            
            if (timerInterval) {
              clearInterval(timerInterval);
              timerInterval = null;
            }
            
            console.log('Recording stopped, chunks:', responseRecordingChunks.length);
            
            if (responseRecordingChunks.length > 0) {
              recordStatus.textContent = 'ë³€í™˜ ì¤‘...';
              
              const webmBlob = new Blob(responseRecordingChunks, { type: 'audio/webm' });
              const wavBlob = await convertWebMToWav(webmBlob);
              
              recordStatus.textContent = 'ì—…ë¡œë“œ ì¤‘...';
              
              const success = await uploadResponseRecording(wavBlob, audioPath, jsPsych.data.get().count());
              
              if (success) {
                recordStatus.textContent = 'âœ… ë…¹ìŒ ì™„ë£Œ!';
                recordStatus.style.color = '#28a745';
                window.trialState.recordingCompleted = true;
                checkSubmitReady();
              } else {
                recordStatus.textContent = 'âš ï¸ ì—…ë¡œë“œ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰ ê°€ëŠ¥)';
                recordStatus.style.color = '#ffc107';
                window.trialState.recordingCompleted = true;
                checkSubmitReady();
              }
            } else {
              recordStatus.textContent = 'âš ï¸ ë…¹ìŒ ë°ì´í„° ì—†ìŒ';
              recordStatus.style.color = '#ffc107';
            }
            
          } catch (err) {
            console.error('Recording stop error:', err);
            recordStatus.textContent = 'âŒ ì˜¤ë¥˜: ' + err.message;
            recordStatus.style.color = '#dc3545';
          }
        });
      },
      on_finish: (data) => {
        data.task = 'rating';
        data.stimulus = jsPsych.evaluateTimelineVariable('file');
        data.cuteness_rating = trialDataStore.slider1Value;
        data.continue_conversation = trialDataStore.slider2Value;
        data.response_choice = trialDataStore.responseChoice || 'none';
        data.other_text = trialDataStore.otherText || '';
        data.trial_start_time = currentTrialStartTime;
        data.response_time = new Date().toISOString();
        data.user_agent = navigator.userAgent;
        data.participant_id = participantId;
        
        console.log('Trial finished:', {
          stimulus: data.stimulus,
          cuteness_rating: data.cuteness_rating,
          continue_conversation: data.continue_conversation,
          response_choice: data.response_choice,
          other_text: data.other_text
        });
      }
    };

    /* ===== RATING BLOCK ===== */
    const rating_block = {
      timeline: [rating_trial],
      timeline_variables: STIMULI,
      randomize_order: true
    };

    /* ===== END ===== */
    const end = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>ê°ì‚¬í•©ë‹ˆë‹¤!</h2>
                 <p>ì‹¤í—˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                 <p>ëª¨ë“  ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>`,
      choices: ['ì¢…ë£Œ']
    };

    /* ===== GOOGLE UPLOAD FOR RATINGS ===== */
    async function uploadAllRowsToGoogle() {
      if (!GAS_ENDPOINT_RATING || GAS_ENDPOINT_RATING.startsWith('PASTE_')) {
        console.warn('No GAS endpoint configured.');
        return false;
      }
      try {
        const allData = jsPsych.data.get().values();
        
        const demoData = allData.find(d => d.task === 'demographics');
        const demographics = demoData?.response || {};
        
        const rows = allData
          .filter(d => d.task === 'rating')
          .map(d => {
            const { rt, rt_original, rt_after_audio, ...cleanData } = d;
            return {
              participant_id:     participantId || '',
              trial_index:        cleanData.trial_index,
              task:               cleanData.task,
              stimulus:           cleanData.stimulus || '',
              cuteness_rating:     cleanData.cuteness_rating ?? '',
              continue_conversation: cleanData.continue_conversation ?? '',
              response_choice:    cleanData.response_choice || '',
              other_text:         cleanData.other_text || '',
              time_elapsed:       cleanData.time_elapsed,
              trial_start_time:   cleanData.trial_start_time || '',
              response_time:      cleanData.response_time || '',
              user_agent:         cleanData.user_agent || navigator.userAgent,
              gender:             demographics.gender || '',
              birth_year:         demographics.birth_year || '',
              birth_month:        demographics.birth_month || '',
              native_lang:        demographics.native_lang || '',
              dialect:            demographics.dialect || ''
            };
          });

        await fetch(GAS_ENDPOINT_RATING, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(rows)
        });
        console.log('Upload attempted. Check your Google Sheet.');
        return true;
      } catch (e) {
        console.warn('Upload error:', e);
        return false;
      }
    }

    /* ===== RUN EXPERIMENT ===== */
    if (jsPsych) {
      console.log('Starting experiment...');
      jsPsych.run([
        preload,
        welcome,
        consent,
        demographics,
        mic_permission,
        intro_page,
        rating_block,
        end
      ]);
    } else {
      console.error('jsPsych not initialized');
    }
  </script>
</body>
</html>
